<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Live Messages</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    #msgs { list-style: none; padding: 0; max-width: 800px; }
    li { padding: 6px 8px; border-bottom: 1px solid #eee; }
    form { margin-top: 12px; }
    input, button { padding: 8px; font-size: 14px; }
  </style>
</head>
<body>
  <h1>Live Messages</h1>
  <div>
    <input id="username" placeholder="username" />
    <button id="setName">Set Name</button>
  </div>
  <ul id="msgs"></ul>

  <form id="post">
    <input id="text" placeholder="message" required />
    <button type="submit">Send</button>
  </form>

  <script>
    const list = document.getElementById('msgs');
    const usernameInput = document.getElementById('username');
    const setNameBtn = document.getElementById('setName');

    const protocol = location.protocol === 'https:' ? 'wss' : 'ws';
    const socket = new WebSocket(protocol + '://' + location.host);

    function render(messages) {
      list.innerHTML = (messages || []).map(m =>
        `<li><small>${new Date(m.timestamp || m.createdAt || '').toLocaleTimeString()}</small> <strong>${escapeHtml(m.username || 'anon')}</strong>: ${escapeHtml(m.content || m.text || '')}</li>`
      ).join('');
    }

    socket.addEventListener('open', () => {
      console.log('ws open');
      // request immediate full list
      socket.send(JSON.stringify({ type: 'messages_fetch' }));
    });

    socket.addEventListener('message', (ev) => {
      let data;
      try { data = JSON.parse(ev.data); } catch { return; }
      if (data.type === 'messages_update') {
        render(data.messages);
      } else if (data.type === 'new_message') {
        // fallback: request full list (server sends full list regularly anyway)
        socket.send(JSON.stringify({ type: 'messages_fetch' }));
      }
    });

    setNameBtn.addEventListener('click', () => {
      const name = usernameInput.value.trim();
      if (!name) return;
      socket.send(JSON.stringify({ type: 'register', username: name }));
    });

    document.getElementById('post').addEventListener('submit', (e) => {
      e.preventDefault();
      const text = document.getElementById('text').value;
      if (!text) return;
      socket.send(JSON.stringify({ type: 'text_message', content: text }));
      document.getElementById('text').value = '';
    });

    function escapeHtml(s) {
      return String(s || '').replace(/[&<>"']/g, (c) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }
  </script>
</body>
</html>